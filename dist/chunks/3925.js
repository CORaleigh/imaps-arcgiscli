(self.webpackChunkimaps=self.webpackChunkimaps||[]).push([[3925],{40365:(e,t,s)=>{"use strict";s.d(t,{Z:()=>r});var i=s(92823);const r=class{constructor(e,t){this._storage=new i.WJ,this._storage.maxSize=e,t&&this._storage.registerRemoveFunc("",t)}put(e,t,s){this._storage.put(e,t,s,1)}pop(e){return this._storage.pop(e)}get(e){return this._storage.get(e)}clear(){this._storage.clearAll()}destroy(){this._storage.clearAll()}get maxSize(){return this._storage.maxSize}set maxSize(e){this._storage.maxSize=e}}},92823:(e,t,s)=>{"use strict";s.d(t,{an:()=>r,Xq:()=>o,WJ:()=>n});var i=s(62698);const r=-3;class o{constructor(e,t,s){this._namespace=e,this._storage=t,this._removeFunc=!1,this._hit=0,this._miss=0,this._storage.register(this),this._namespace+=":",s&&(this._storage.registerRemoveFunc(this._namespace,s),this._removeFunc=!0)}get namespace(){return this._namespace.slice(0,-1)}get hitRate(){return this._hit/(this._hit+this._miss)}get size(){return this._storage.size}get maxSize(){return this._storage.maxSize}resetHitRate(){this._hit=this._miss=0}destroy(){this._storage.clear(this._namespace),this._removeFunc&&this._storage.deregisterRemoveFunc(this._namespace),this._storage.deregister(this)}put(e,t,s,i=0){this._storage.put(this._namespace+e,t,s,i)}get(e){const t=this._storage.get(this._namespace+e);return void 0===t?++this._miss:++this._hit,t}pop(e){const t=this._storage.pop(this._namespace+e);return void 0===t?++this._miss:++this._hit,t}updateSize(e,t,s){this._storage.updateSize(this._namespace+e,t,s)}clear(){this._storage.clear(this._namespace)}clearAll(){this._storage.clearAll()}getStats(){return this._storage.getStats()}resetStats(){this._storage.resetStats()}}class n{constructor(e=10485760){this._maxSize=e,this._db=new Map,this._size=0,this._hit=0,this._miss=0,this._removeFuncs=[],this._users=new i.Z}register(e){this._users.push(e)}deregister(e){this._users.removeUnordered(e)}registerRemoveFunc(e,t){this._removeFuncs.push([e,t])}deregisterRemoveFunc(e){this._removeFuncs=this._removeFuncs.filter((t=>t[0]!==e))}get size(){return this._size}get maxSize(){return this._maxSize}set maxSize(e){this._maxSize=Math.max(e,0),this._checkSizeLimit()}put(e,t,s,i){const r=this._db.get(e);if(r&&(this._size-=r.size,this._db.delete(e),r.entry!==t&&this._notifyRemoved(e,r.entry)),s>this._maxSize)return void this._notifyRemoved(e,t);if(void 0===t)return void console.warn("Refusing to cache undefined entry ");if(!s||s<0)return void console.warn("Refusing to cache entry with invalid size "+s);const o=1+Math.max(i,-3)- -3;this._db.set(e,{entry:t,size:s,lifetime:o,lives:o}),this._size+=s,this._checkSizeLimit()}updateSize(e,t,s){const i=this._db.get(e);i&&i.entry===t&&(this._size-=i.size,s>this._maxSize?this._notifyRemoved(e,t):(i.size=s,this._size+=s,this._checkSizeLimit()))}pop(e){const t=this._db.get(e);if(t)return this._size-=t.size,this._db.delete(e),++this._hit,t.entry;++this._miss}get(e){const t=this._db.get(e);if(void 0!==t)return this._db.delete(e),t.lives=t.lifetime,this._db.set(e,t),++this._hit,t.entry;++this._miss}getStats(){const e={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},t={},s=new Array;this._db.forEach(((e,i)=>{const r=e.lifetime;s[r]=(s[r]||0)+e.size,this._users.forAll((s=>{const r=s.namespace;if(i.startsWith(r)){const s=t[r]||0;t[r]=s+e.size}}))}));const i={};this._users.forAll((e=>{const s=e.namespace;if(!isNaN(e.hitRate)&&e.hitRate>0){const r=t[s]||0;t[s]=r,i[s]=Math.round(100*e.hitRate)+"%"}else i[s]="0%"}));const r=Object.keys(t);r.forEach((e=>t[e]=t[e]/this._size*100)),r.sort(((e,s)=>t[s]-t[e])),r.forEach((s=>e[s]=Math.round(t[s])+"% / "+i[s]));for(let t=s.length-1;t>=0;--t){const i=s[t];i&&(e["Priority "+(t+-3-1)]=Math.round(i/this.size*100)+"%")}return e}resetStats(){this._hit=this._miss=0,this._users.forAll((e=>e.resetHitRate()))}clear(e){this._db.forEach(((t,s)=>{s.startsWith(e)&&(this._size-=t.size,this._db.delete(s),this._notifyRemoved(s,t.entry))}))}clearAll(){this._db.forEach(((e,t)=>this._notifyRemoved(t,e.entry))),this._size=0,this._db.clear()}_getHitRate(){return this._hit/(this._hit+this._miss)}_notifyRemoved(e,t){this._removeFuncs.forEach((s=>{e.startsWith(s[0])&&s[1](t)}))}_checkSizeLimit(){if(!(this._size<=this._maxSize))for(const[e,t]of this._db)if(this._db.delete(e),t.lives<=1?(this._size-=t.size,this._notifyRemoved(e,t.entry)):(--t.lives,this._db.set(e,t)),this._size<=.9*this.maxSize)return}}},43925:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>R});var i,r=s(56140),o=(s(95830),s(82550)),n=s(59472),a=s(88263),h=s(36544),l=(s(68055),s(79881)),c=s(87566),u=s(60538),_=s(32656),m=(s(10923),s(57002),s(86035),s(39105)),d=s(30927),p=s(4665),f=s(78745),g=s(82314),y=s(54721),b=s(71598),v=s(19540),z=s(40365);const S=h.Z.getLogger("esri.renderers.DictionaryRenderer");let x=i=class extends((0,v.W)(b.Z)){constructor(e){super(e),this._ongoingRequests=new Map,this._symbolCache=new z.Z(100),this.config=null,this.fieldMap=null,this.scaleExpression=null,this.scaleExpressionTitle=null,this.url=null,this.type="dictionary"}writeData(e,t){e&&(t.scalingExpressionInfo={expression:e,returnType:"number"})}writeVisualVariables(e,t,s,i){null!=i&&i.origin||super.writeVisualVariables(e,t,s,i)}clone(){return new i({config:(0,o.d9)(this.config),scaleExpression:this.scaleExpression,scaleExpressionTitle:this.scaleExpressionTitle,fieldMap:(0,o.d9)(this.fieldMap),url:(0,o.d9)(this.url),visualVariables:(0,o.d9)(this.visualVariables)})}async getSymbolAsync(e,t){let s;this._dictionaryPromise||(this._dictionaryPromise=this.fetchResources(t));try{s=await this._dictionaryPromise}catch(e){if((0,m.isAbortError)(e))return this._dictionaryPromise=null,null}const i={};if(this.fieldMap)for(const t of this._symbolFields){const s=this.fieldMap[t];if(s&&null!==e.attributes[s]&&void 0!==e.attributes[s]){const r=""+e.attributes[s];i[t]=r}else i[t]=""}const r=s(i,t);if(!r||"string"!=typeof r)return null;const o=(0,a.hP)(r).toString(),n=this._symbolCache.get(o);if(n)return n.catch((()=>{this._symbolCache.pop(o)})),n;const h=r.split(";"),l=[],c=[];for(const e of h)if(e&&0!==e.length)if(-1===e.indexOf("po:"))if(-1!==e.indexOf("|"))for(const t of e.split("|"))this._itemNames.has(t)&&l.push(t);else this._itemNames.has(e)&&l.push(e);else{const t=e.substr(3).split("|");if(3===t.length){const e=t[0],s=t[1];let i=t[2];if("DashTemplate"===s)i=i.split(" ").map((e=>Number(e)));else if("Color"===s){const e=new f.default(i).toRgba();i=[e[0],e[1],e[2],255*e[3]]}else i=Number(i);c.push({primitiveName:e,propertyName:s,value:i})}}const u=this._cimPartsToCIMSymbol(l,c,t);return this._symbolCache.put(o,u,1),u}async collectRequiredFields(e,t){await this.collectVVRequiredFields(e,t),this.scaleExpression&&await(0,p.io)(e,t,this.scaleExpression);const s=t.map((e=>e.name));for(const t in this.fieldMap)s.indexOf(this.fieldMap[t])<0||e.add(this.fieldMap[t])}get arcadeRequired(){return!0}async fetchResources(e){if(this._dictionaryPromise)return this._dictionaryPromise;if(!this.url)return void S.error("no valid URL!");const t=(0,n.pC)(e)?e.abortOptions:null,s=(0,y.default)(this.url+"/resources/styles/dictionary-info.json",{responseType:"json",query:{f:"json"},...t}),[{data:i}]=await(0,m.all)([s,(0,d.LC)()]);if(!i)throw this._dictionaryPromise=null,new _.Z("esri.renderers.DictionaryRenderer","Bad dictionary data!");const r=i.expression,o=i.authoringInfo;this._refSymbolUrlTemplate=this.url+"/"+i.cimRefTemplateUrl,this._itemNames=new Set(i.itemsNames),this._symbolFields=o.symbol;const a={};if(this.config){const e=this.config;for(const t in e)a[t]=e[t]}for(const e of o.configuration)a.hasOwnProperty(e.name)||(a[e.name]=e.value);const h=[];if((0,n.pC)(e)&&e.fields&&this.fieldMap)for(const t of this._symbolFields){const s=this.fieldMap[t],i=e.fields.filter((e=>e.name===s));i.length>0&&h.push({...i[0],name:t})}return this._dictionaryPromise=(0,d.pp)(r,(0,n.pC)(e)?e.spatialReference:null,h,a).then((e=>{const t={scale:0};return(s,i)=>{const r=e.repurposeFeature({geometry:null,attributes:s});return t.scale=(0,n.pC)(i)?i.scale:void 0,e.evaluate({$feature:r,$view:t})}})).catch((e=>(S.error("Creating dictinoary expression failed:",e),null))),this._dictionaryPromise}getSymbol(){return null}getSymbols(){return[]}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce(((e,t)=>e+t.getAttributeHash()),"")}getMeshHash(){return`${this.url}-${JSON.stringify(this.fieldMap)}`}getSymbolFields(){return this._symbolFields}async _getSymbolPart(e,t){if(this._ongoingRequests.has(e))return this._ongoingRequests.get(e).then((e=>e.data));const s=this._refSymbolUrlTemplate.replace(/\{itemName\}/gi,e),i=(0,y.default)(s,{responseType:"json",query:{f:"json"},...t});this._ongoingRequests.set(e,i);try{return(await i).data}catch(t){return this._ongoingRequests.delete(e),(0,m.reject)(t)}}_combineSymbolParts(e,t){if(!e||0===e.length)return null;if(1===e.length)return{type:"CIMSymbolReference",symbol:e[0],primitiveOverrides:t};const s={...e[0]};s.symbolLayers=[];for(const t of e){const e=t;s.symbolLayers.unshift(...e.symbolLayers)}return{type:"CIMSymbolReference",symbol:s,primitiveOverrides:t}}async _cimPartsToCIMSymbol(e,t,s){const i=new Array(e.length);for(let t=0;t<e.length;t++)i[t]=this._getSymbolPart(e[t],s);const r=await(0,m.all)(i);return new g.Z({data:this._combineSymbolParts(r,t)})}};(0,r._)([(0,l.Cb)({type:Object,json:{read:{source:"configuration"},write:{target:"configuration"}}})],x.prototype,"config",void 0),(0,r._)([(0,l.Cb)({type:Object,json:{write:!0}})],x.prototype,"fieldMap",void 0),(0,r._)([(0,l.Cb)({type:String,json:{read:{source:"scalingExpressionInfo.expression"},write:!0}})],x.prototype,"scaleExpression",void 0),(0,r._)([(0,u.c)("scaleExpression")],x.prototype,"writeData",null),(0,r._)([(0,l.Cb)({type:String,json:{read:{source:"scalingExpressionInfo.title"},write:{target:"scalingExpressionInfo.title",overridePolicy(e){return{enabled:!!e&&!!this.scaleExpression}}}}})],x.prototype,"scaleExpressionTitle",void 0),(0,r._)([(0,l.Cb)({type:String,json:{write:!0}})],x.prototype,"url",void 0),(0,r._)([(0,u.c)("visualVariables")],x.prototype,"writeVisualVariables",null),x=i=(0,r._)([(0,c.j)("esri.renderers.DictionaryRenderer")],x);const R=x}}]);
//# sourceMappingURL=3925.js.map